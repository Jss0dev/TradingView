//@version=6
indicator("카르마 채널 (채널 로직만)", overlay=true, max_bars_back=500)
// ──────────────────────────────────────────────────────────────
// [상수] CONSTANTS
// ──────────────────────────────────────────────────────────────
const string groupCHANNEL = "CHANNEL"

// ──────────────────────────────────────────────────────────────
// [입력값] CHANNEL
// ──────────────────────────────────────────────────────────────
int   length        = input.int(150, "채널 길이", minval=2, group=groupCHANNEL)
float channel_width = input.float(1.5, "채널 폭", step=0.1, minval=0.1, group=groupCHANNEL)

// ──────────────────────────────────────────────────────────────
// [계산 로직] LOGIC
// ──────────────────────────────────────────────────────────────

// 로그 회귀 함수 (가격의 로그에 대해 회귀 후, 지수로 복원)
f_log_regression(src, len) =>
    float sumX = 0.0, sumY = 0.0, sumXSqr = 0.0, sumXY = 0.0
    for i = 0 to len - 1
        float per = i + 1.0
        float val = math.log(src[i])
        sumX += per
        sumY += val
        sumXSqr += per * per
        sumXY += val * per
    float slope = (len * sumXY - sumX * sumY) / (len * sumXSqr - sumX * sumX)
    float intercept = (sumY - slope * sumX) / len
    [slope, intercept]

// 충분한 바 보유 여부
bool bar_ready = bar_index >= length

// 롤링 회귀 기반 중앙/상단/하단 시리즈 계산
float midLine = na
float upLine  = na
float lowLine = na

if bar_ready
    [slope, intercept] = f_log_regression(close, length)
    float dev = ta.stdev(close, length)
    midLine := math.exp(intercept + slope * 1.0)                // 현재(윈도우 끝)의 회귀값
    upLine := midLine + dev * channel_width
    lowLine := midLine - dev * channel_width

// ──────────────────────────────────────────────────────────────
// plot 시리즈 (모습 탭에서 색/두께/표시 제어)
// ──────────────────────────────────────────────────────────────
plot(close, title="anchor", color=color.new(color.white, 100))  // 보조 앵커(숨김용)

pMid = plot(midLine, title="50선",   color=color.gray, linewidth=2)     // Style 탭에서 표시/색 변경
pUp  = plot(upLine,  title="상단",    color=color.new(#a7abb9, 0), linewidth=2)
pLow = plot(lowLine, title="하단",    color=color.new(#a7abb9, 0), linewidth=2)

// 채널 채움 (모습 탭에서 채움 색·표시 변경 가능)
fill(pUp, pLow, color=color.new(color.gray, 90), title="채널 채움")
